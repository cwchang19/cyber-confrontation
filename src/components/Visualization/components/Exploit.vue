<template>
  <div class="exploit-container">
    <el-row>
      <el-alert title="漏洞说明" type="warning" effect="light" show-icon :closable="false">
        <template>
          <div>1. 每个场景至少设置一个漏洞。</div>
          <div>2. 漏洞由（服务，操作系统，成功概率，动作成本，可获取权限）构成。</div>
          <div>3. 服务：漏洞的目标服务。</div>
          <div>4. 操作系统：漏洞的目标操作系统。</div>
          <div>5. 成功概率：在满足所有先决条件的情况下漏洞利用成功的概率（先决条件即发现并可访问目标主机，并且主机正在运行目标服务和操作系统）。</div>
          <div>6. 动作成本：执行当前操作的成本，可表示任何意义上的操作成本，例如时间、产生的流量等。</div>
          <div>7. 可获取权限：漏洞利用成功后，将在目标主机上获取的访问权限，可以是user（用户权限）或root（根权限）。</div>
        </template>
      </el-alert>
    </el-row>
    <el-row type="flex" justify="end" style="padding: 10px 10px">
      <el-button type="success" size="small" @click="addExploit">新增漏洞</el-button>
      <el-button type="primary" size="small" @click="saveExploit">保存</el-button>
    </el-row>
    <el-row>
    </el-row>
    <el-table :data="exploits" stripe>
      <el-table-column props="no" label="No" type="index">
      </el-table-column>
      <el-table-column props="service" label="服务">
        <template slot-scope="scope">
          <el-select v-model="scope.row.service" size="mini" placeholder="选择服务" filterable>
            <el-option v-for="item in services" :key="item.value" :label="item.label" :value="item.value"></el-option>
          </el-select>
        </template>
      </el-table-column>
      <el-table-column props="os" label="操作系统">
        <template slot-scope="scope">
          <el-select v-model="scope.row.os" size="mini" placeholder="选择操作系统" filterable>
            <el-option v-for="item in os" :key="item.value" :label="item.label" :value="item.value"></el-option>
          </el-select>
        </template>
      </el-table-column>
      <el-table-column props="prob" label="成功概率[0-1]">
        <template slot-scope="scope">
          <el-input v-model="scope.row.prob" placeholder="[0, 1]的小数" size="mini"></el-input>
          <!-- <el-input-number v-model="scope.row.prob" size="mini" precision="2" :min="0" :max="1"
            :controls="false" style="width: 100%;">
          </el-input-number> -->
        </template>
      </el-table-column>
      <el-table-column props="cost" label="动作成本">
        <template slot-scope="scope">
          <el-input v-model="scope.row.cost" placeholder="非负值" size="mini"></el-input>
        </template>
      </el-table-column>
      <el-table-column props="access" label="获取访问权限">
        <template slot-scope="scope">
          <el-select v-model="scope.row.access" size="mini" placeholder="选择可获取权限" filterable>
            <el-option key="user" label="user" value="user"></el-option>
            <el-option key="root" label="root" value="root"></el-option>
          </el-select>
        </template>
      </el-table-column>
      <el-table-column width="50">
        <template slot-scope="scope">
          <el-button type="text" size="mini" icon="el-icon-close" @click="deleteExploit(scope)"></el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import { deepCopy } from '@/utils/other';
import { Notification } from 'element-ui';

export default {
  name: 'Exploit',
  props: {
    curExploit: {
      type: Array,
      default: null
    },
    curSubnet: {
      type: Object,
      default: null
    }
  },
  data() {
    return {
      os: [],
      services: [],
      exploits: [],
    }
  },
  created() {
    this.fetchData();
  },
  methods: {
    fetchData() {
      if (this.curSubnet) {
        let serviceSet = new Set();
        let osSet = new Set();
        for (let subnetKey in this.curSubnet) {
          for (let hostKey in this.curSubnet[subnetKey].hosts) {
            for (let service of this.curSubnet[subnetKey].hosts[hostKey].services) {
              serviceSet.add(service);
            }
            osSet.add(this.curSubnet[subnetKey].hosts[hostKey].os);
          }
        }
        this.services = [...serviceSet];
        this.os = [...osSet];
        for (let i = 0; i < this.services.length; i++) {
          this.services[i] = {
            value: this.services[i],
            label: this.services[i]
          }
        }
        for (let i = 0; i < this.os.length; i++) {
          this.os[i] = {
            value: this.os[i],
            label: this.os[i]
          }
        }
        this.os.unshift({
          value: null,
          label: '任意操作系统'
        })
        // console.log(this.services);
      }
      // console.log(this.curSubnetFirewall);
      if (this.curExploit) {
        this.exploits = deepCopy(this.curExploit);
      }
    },
    addExploit() {
      this.exploits.push({
        service: '',
        os: '',
        prob: '',
        cost: '',
        access: ''
      })
    },
    saveExploit() {
      const errorMsg = this.checkValidate();
      if(errorMsg == '') {
        this.$emit('watchExploit', deepCopy(this.exploits));
        // this.$message.success('保存成功');
      } else {
        Notification({
          type: 'error',
          dangerouslyUseHTMLString: true,
          message: errorMsg,
          duration: 0,
          position: 'top-left'
        })
      }
    },
    deleteExploit(scope) {
      this.exploits.splice(scope.$index, 1);
    },
    checkValidate() {
      let result = '';
      if(this.exploits.length == 0) {
        result += `场景内至少需要设置一个漏洞</br>`;
      }
      for(let i=0; i<this.exploits.length; i++) {
        // console.log()
        if(this.exploits[i].service == '') {
          result += `序号${i+1}：服务不能为空</br>`;
        }
        if(this.exploits[i].os == '') {
          result += `序号${i+1}：操作系统不能为空</br>`;
        }
        let prob = parseFloat(this.exploits[i].prob);
        if(Object.is(prob, NaN) || prob > 1 || prob < 0) {
          result += `序号${i+1}：输入的成功概率不合法，应为[0, 1]间的小数</br>`;
        } else {
          this.exploits[i].prob = prob;
        }
        let cost = parseFloat(this.exploits[i].cost);
        if(Object.is(cost, NaN) || cost < 0) {
          result += `序号${i+1}：输入的动作成本不合法，应为非负值</br>`;
        } else {
          this.exploits[i].cost = cost;
        }
        if(this.exploits[i].access == '') {
          result += `序号${i+1}：可获取访问权限不能为空</br>`;
        }
      }
      return result;
    }
  }
}
</script>

<style scoped>

</style>